@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Quartz.Net 任务管理</title>
    <link href="~/bootstrap-3.3.5-dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/bootstrap-3.3.5-dist/css/bootstrap-theme.min.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-1.12.0.min.js"></script>
    <script src="~/Scripts/json2.js"></script>
    <script src="~/Scripts/jquery-form.js"></script>
    <link href="~/bootstrap-3.3.5-dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="~/bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        //$(function () {
        //    $("#divTb").on("click", "button.btn", function () { alert("123") });
        //    getAllScheduler();
        //});

    </script>
    <script type="text/javascript">
        $(function () {
            getAllScheduler();
            $("#btnRefresh").click(getAllScheduler);
            $("#btnRevise").click(revise);
            $("#btnReload").click(reloadScheduler);

            $("#btnUpload").click(uploadZip);


            $("#divTb").on("click", "button[cmdStart]", startScheduler);


            $("#divTb").on("click", "button[cmdStop]", stopScheduler);

            $("#divTb").on("click", "button[cmdkill]", killProcess);

            $("#divTb").on("click", "button[cmdUpload]", openUploadModal);



            $("#divTb").on("click", "button[cmdPauseJob]", pauseJob);


            $("#divTb").on("click", "button[cmdResumeJob]", resumeJob);


        });

        $.ajaxSetup({
            error: function (data) {
                showWarn("提示", data);
            },
            beforeSend: function () { $("#modalMask").modal({ show: true, backdrop: 'static' }); },
            complete: function () { $("#modalMask").modal('hide'); }
        });

        function openUploadModal() {

            var self = $(this);
            var sch = getScheduler(self);
            $("#modelTitle").text(sch.schName);
            $("#hidSchId").val(sch.schId);
            $("#modalUpload").modal({
                show: true,
                keyboard: false

            });
        }

        function uploadZip() {
            var self = $(this);
            var sch = getScheduler(self);
            $("#form1").ajaxSubmit({
                url: '@Url.Action("UploadApplication")',
                success: function (data) {
                    showCallbackDefault(data);
                    $("#modalUpload").modal("hide");
                }
            });

        }

        function startScheduler() {
            var self = $(this);
            var sch = getScheduler(self);

            $.ajax({
                url: '@Url.Action("StartScheduler")',
                data: { schId: sch.schId },
                type: 'post',
                dataType: "json",
                success: function (data) {
                    showCallbackDefault(data);
                }
            });

        }

        function stopScheduler() {
            var self = $(this);
            var sch = getScheduler(self);

            $.ajax({
                url: '@Url.Action("ShutDown")',
                data: { schId: sch.schId },
                type: 'post',
                dataType: "json",
                success: function (data) {
                    showCallbackDefault(data);
                }
            });


        }

        function killProcess() {
            var self = $(this);
            var sch = getScheduler(self);
            $.ajax({
                url: '@Url.Action("KillProcess")',
                data: { schId: sch.schId },
                type: "post",
                dataType: "json",
                success: function (data) {
                    showCallbackDefault(data);
                }
            });



        }

        function getScheduler(ele) {

            var self = $(ele);
            var p = self.parents("tr");
            return { schId: p.attr("schId"), schName: p.attr("schName") }
        }


        function revise() {
            $.ajax({
                url: '@Url.Action("Revise")',
                type: "post",
                dataType: "json",
                success: function (data) {
                    showCallbackDefault(data);
                }
            });
        }

        function reloadScheduler() {
            $.ajax({
                url: '@Url.Action("ReloadScheduler")',
                type: "post",
                dataType: "json",
                success: function (data) {
                    showCallbackDefault(data);
                }
            });
        }

        function pauseJob() {
            $.ajax({
                url: '@Url.Action("PauseJob")',
                data: getJob($(this)),
                type: "post",
                dataType: "json",
                success: function (data) {
                    showCallbackDefault(data);
                }
            });

        }

        function resumeJob() {
            $.ajax({
                url: '@Url.Action("ResumeJob")',
                data: getJob($(this)),
                type: "post",
                dataType: "json",
                success: function (data) {
                    showCallbackDefault(data);
                }
            });

        }
        function getJob(ele) {
            var self = $(ele);
            return { schId: self.attr("schId"), groupName: self.attr("groupname"), jobName: self.attr("jobname") };
        }

        function getAllScheduler() {
            $("#divTb").load('@Url.Action("AllScheduler")')
        }
    </script>



</head>
<body style="padding-top: 70px; ">

    <nav class="navbar navbar-default  navbar-fixed-top">
        <div class="container">
            <span class="navbar-brand" href="#">Quartz.Net 任务管理</span>
        </div>

    </nav>
    <div class="container theme-showcase" role="main">

        <!-- Main jumbotron for a primary marketing message or call to action -->
        <div class="page-header">
            <h3>任务列表</h3>
        </div>

        <div class="row">
            <div class="col-md-12">
                <button class="btn btn-default" id="btnRefresh">
                    <span class="glyphicon  glyphicon-repeat" aria-hidden="true"></span>刷新
                </button>

                <button class="btn btn-info" id="btnRevise">
                    <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>校验任务
                </button>
                <button class="btn btn-success" id="btnReload">
                    <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>重新加载任务
                </button>
                <button class="btn btn-warning" id="btnRefresh">问?</button>
            </div>
            <div class="col-md-12" id="divTb">
            </div>

        </div>
    </div>

    <!-- Modal -->
    <!--文件上传-->
    <div class="modal fade" id="modalUpload" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="modelTitle"></h4>
                </div>
                <div class="modal-body">
                    <form id="form1" action="" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="schId" id="hidSchId" />
                        <input type="file" id="fileUpload" name="fileUpload" />
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="btnUpload">确认</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalWarn" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>

                    <h5><span class="glyphicon glyphicon-warning-sign"></span><span id="spanWarnTitle"></span></h5>
                </div>
                <div class="modal-body" id="divWarnMsg">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">确认</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="modalInfo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>

                    <h5><span class="glyphicon glyphicon-info-sign"></span><span id="spanInfoTitle"></span></h5>
                </div>
                <div class="modal-body" id="divInfoMsg">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">确认</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalMask" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    </div>

    <script type="text/javascript">

        function showCallbackDefault(callback) {
            if (callback.result) {
                getAllScheduler();
            } else {
                showWarn("提示", callback.msg);
            }
        }
        function showWarn(title, msg) {
            $("#spanWarnTitle").text(title);
            $("#divWarnMsg").text(msg);
            $("#modalWarn").modal({
                show: true,
                keyboard: false
            })
        }



        function showInfo(title, msg) {
            $("#spanInfoTitle").text(title);
            $("#divInfoMsg").text(msg);
            $("#modalInfo").modal({
                show: true,
                keyboard: false
            })
        }
    </script>
</body>
</html>
